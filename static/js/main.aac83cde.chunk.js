(this.webpackJsonprotorify=this.webpackJsonprotorify||[]).push([[0],{18:function(t,e,r){},19:function(t,e,r){},39:function(t,e,r){"use strict";r.r(e);var n=r(3),a=r.n(n),i=r(13),s=r.n(i),o=(r(18),r.p,r(19),r(1)),c=r(5),l=r.n(c),u=r(6),d=r(2),m=r(4),b=function(t,e,r){return Math.max(e,Math.min(r,t))},h=function(t,e,r){return b((r-t)/(e-t),0,1)},p=function(t){var e=a.a.useRef(),r=a.a.useRef(),n=function n(a){if(void 0!=r.current){var i=a-r.current;t(i)}r.current=a,e.current=requestAnimationFrame(n)};a.a.useEffect((function(){return e.current=requestAnimationFrame(n),function(){return cancelAnimationFrame(e.current)}}),[])};var f=r(0),v=window.Ammo,j=r(38),g=(r(22),r(36)),x=(r(37),null),y=.001,w="training.alt",O=function(){return{battery:100,batteryChart:[],yChart:[],vyChart:[],throttle:0,ms:0,stage:w,pids:{alt:{p:1,i:0,d:0,accI:[]}},simTime:0,deltaToSim:0,training:{maxspeed:!0,alt:{currentErrAcc:0,errs:[],p:.1,i:.001,d:.01,currentDir:"p",target:function(t){return 2+1.5*h(-.1,.1,Math.sin(2*Math.PI*2*Math.pow(t/15e3,2)))}}}}};function M(t){var e,r,n;r=new j.Scene,(n=new j.WebGLRenderer({canvas:t,antialias:!0})).setSize(window.innerWidth-300,window.innerHeight),(r=new j.Scene).background=new j.Color(12571109),(e=new j.PerspectiveCamera(70,(window.innerWidth-300)/window.innerHeight,.2,5e3)).position.set(0,1.7,4),e.lookAt(new j.Vector3(0,1.7,0));var a=new j.HemisphereLight(16777215,16777215,.1);a.color.setHSL(.6,.6,.6),a.groundColor.setHSL(.1,1,.4),a.position.set(0,50,0),r.add(a);var i=new j.DirectionalLight(16777215,1);i.color.setHSL(.1,1,.95),i.position.set(-1,1.75,1),i.position.multiplyScalar(100),r.add(i),i.castShadow=!0,i.shadow.mapSize.width=2048,i.shadow.mapSize.height=2048;i.shadow.camera.left=-10,i.shadow.camera.right=10,i.shadow.camera.top=10,i.shadow.camera.bottom=-10,i.shadow.camera.far=13500,n.setClearColor(12571109),n.setPixelRatio(window.devicePixelRatio),n.setSize(window.innerWidth-300,window.innerHeight),n.gammaInput=!0,n.gammaOutput=!0,n.shadowMap.enabled=!0;var s=function(t){var e=t.scene,r={x:0,y:3,z:0},n={x:.1,y:.1,z:.1},a=new j.Mesh(new j.BoxBufferGeometry,new j.MeshPhongMaterial({color:16711935}));return a.position.set(r.x,r.y,r.z),a.scale.set(n.x,n.y,n.z),a.castShadow=!0,a.receiveShadow=!0,e.add(a),function(t,e,r){return a.position.set(t,e,r)}}({scene:r});return{camera:e,scene:r,renderer:n,target:s}}function C(t){var e=t.physicsWorld,r=t.scene,n=0,a=-1,i=0,s=20,o=2,c=20,l=0,u=0,d=0,m=1,b=new j.Mesh(new j.BoxBufferGeometry,new j.MeshPhongMaterial({color:10530724}));b.position.set(n,a,i),b.scale.set(s,o,c),b.castShadow=!0,b.receiveShadow=!0,r.add(b);var h=new v.btTransform;h.setIdentity(),h.setOrigin(new v.btVector3(n,a,i)),h.setRotation(new v.btQuaternion(l,u,d,m));var p=new v.btDefaultMotionState(h),f=new v.btBoxShape(new v.btVector3(.5*s,.5*o,.5*c));f.setMargin(.05);var g=new v.btVector3(0,0,0);f.calculateLocalInertia(0,g);var x=new v.btRigidBodyConstructionInfo(0,p,f,g),y=new v.btRigidBody(x);e.addRigidBody(y)}function S(t){!function(t){for(var e=t.physicsWorld,r=t.scene,n=t.rigidBodies,a=0;a<n.length;a++){var i=n[a],s=i.userData.physicsBody;e.removeRigidBody(s);try{v.destroy(s.getCollisionShape()),v.destroy(s.getMotionState()),v.destroy(s)}catch(o){console.error(o)}r.remove(i)}n.length=0}(t),function(t){var e=t.physicsWorld,r=t.scene,n=t.rigidBodies,a=t.droneData,i=0,s=5,o=0,c=0,l=0,u=0,d=1,m=a.totalMass/1e3,b=new j.Group;if("quadrotor +"===a.type){var h=.02,p=a.motorCenterDistance/1e3,f=new j.Mesh(new j.SphereBufferGeometry(h),new j.MeshPhongMaterial({color:16712965}));f.position.set(p,0,0),f.castShadow=!0,b.add(f);var g=new j.Mesh(new j.SphereBufferGeometry(h),new j.MeshPhongMaterial({color:16712965}));g.position.set(-p,0,0),g.castShadow=!0,b.add(g);var x=new j.Mesh(new j.SphereBufferGeometry(h),new j.MeshPhongMaterial({color:16712965}));x.position.set(0,0,-p),x.castShadow=!0,b.add(x);var y=new j.Mesh(new j.SphereBufferGeometry(h),new j.MeshPhongMaterial({color:16712965}));y.position.set(0,0,p),y.castShadow=!0,b.add(y);var w=new j.Mesh(new j.BoxBufferGeometry(.01,.01,2*p),new j.MeshPhongMaterial({color:0}));w.position.set(0,0,0),w.castShadow=!0,b.add(w);var O=new j.Mesh(new j.BoxBufferGeometry(2*p,.01,.01),new j.MeshPhongMaterial({color:0}));O.position.set(0,0,0),O.castShadow=!0,b.add(O)}b.position.set(i,s,o),b.castShadow=!0,b.receiveShadow=!0,r.add(b);var M=new v.btTransform;M.setIdentity();var C=new v.btVector3(i,s,o);M.setOrigin(C),v.destroy(C);var S=new v.btQuaternion(c,l,u,d);M.setRotation(S),v.destroy(S);var D=new v.btDefaultMotionState(M);v.destroy(M);var B=new v.btBoxShape(new v.btVector3(a.motorCenterDistance/1e3,.02,a.motorCenterDistance/1e3));B.setMargin(.05);var V=new v.btVector3(0,0,0);B.calculateLocalInertia(m,V);var I=new v.btRigidBodyConstructionInfo(m,D,B,V),P=new v.btRigidBody(I);P.setActivationState(4),b.userData.physicsBody=P,e.addRigidBody(P),n.push(b)}(t),t.sim=O()}function D(){var t=new v.btDefaultCollisionConfiguration,e=new v.btCollisionDispatcher(t),r=new v.btDbvtBroadphase,n=new v.btSequentialImpulseConstraintSolver,a=new v.btDiscreteDynamicsWorld(e,r,n,t);return a.setGravity(new v.btVector3(0,-9.8,0)),x=new v.btTransform,a}function B(){var t,e=Object(n.useRef)(null),r=Object(n.useRef)(),a=Object(n.useState)({type:"quadrotor +",motorCenterDistance:100,motorKV:1e4,motorMass:20,motorLiftPerWatt:.05,escMass:20,batteryMass:100,batteryS:2,batteryP:1,batteryC:45,batteryCapacity:850,frameMass:100,totalMass:0,v:0,mA:0,w:0,j:0}),i=Object(m.a)(a,2),s=i[0],c=i[1],h=Object(n.useState)(O()),j=Object(m.a)(h,2),B=j[0],R=j[1],A=Object(n.useState)(!1),T=Object(m.a)(A,2),W=T[0],L=T[1];function k(t){c(t),L(!1)}return Object(n.useEffect)((function(){if(W){var t;(null===(t=e.current)||void 0===t?void 0:t.alive)&&(e.current.droneData=s,S(e.current))}else{var r,n=Object(d.a)(Object(d.a)(Object(d.a)({},g(s)),function(t){var e=3.7*t.batteryS,r=t.batteryC*t.batteryCapacity;return{v:e,mA:r,w:e*r/1e3,j:3600*t.batteryCapacity/1e3*e}}(s)),{totalMass:4*(a=s).escMass+4*a.motorMass+a.batteryMass+a.frameMass});(null===(r=e.current)||void 0===r?void 0:r.alive)&&(e.current.droneData=n),c(n),L(!0)}var a}),[s,W]),Object(n.useEffect)((function(){var t;function n(){return a.apply(this,arguments)}function a(){return(a=Object(u.a)(l.a.mark((function t(){return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("Trying to load Ammo.js"),t.prev=1,t.next=4,v();case 4:v=t.sent,e.current=M(r.current),e.current.physicsWorld=D(),e.current.rigidBodies=[],C(e.current),e.current.alive=!0,L(!1),e.current.sim=O(),t.next=18;break;case 14:t.prev=14,t.t0=t.catch(1),console.error("ammo: ",t.t0),setTimeout((function(){return n()}),500);case 18:case"end":return t.stop()}}),t,null,[[1,14]])})))).apply(this,arguments)}void 0==(null===(t=v)||void 0===t?void 0:t.btDefaultCollisionConfiguration)&&n()}),[]),p((function(t){if(null!=e.current){var r=e.current,n=r.camera,a=r.scene,i=r.renderer,s=r.sim,o=(r.droneData,r.rigidBodies);r.physicsWorld;o.length>0&&function(t,e){var r=performance.now();if(t.sim.deltaToSim=e,t.sim.simTime=0,t.droneData){var n=function(t){var e=t.sim,r=t.rigidBodies,n=t.physicsWorld,a=t.droneData;n.stepSimulation(.001,0);var i=r[0].userData.physicsBody;i.getMotionState().getWorldTransform(x);var s=[x.getOrigin().x(),x.getOrigin().y(),x.getOrigin().z()][1],o=[i.getLinearVelocity().x(),i.getLinearVelocity().y(),i.getLinearVelocity().z()][1];if(e.stage===w){i.getMotionState().getWorldTransform(x);var c={x:0,y:0,z:0,w:1},l=new v.btQuaternion(c.x,c.y,c.z,c.w);x.setRotation(l),v.destroy(l),i.getMotionState().setWorldTransform(x);var u=t.sim.training.alt.target(e.ms);t.target(0,u,0);var d=u-s;e.ms>=0&&(t.sim.training.alt.currentErrAcc+=Math.pow(Math.abs(d/100),1)),e.pids.alt.accI=e.pids.alt.accI+d/100,e.pids.alt.accI*=.995,e.pids.alt.pContrib=e.pids.alt.p*d,e.pids.alt.dContrib=-e.pids.alt.p*e.pids.alt.d*o,e.pids.alt.iContrib=e.pids.alt.p*e.pids.alt.i*e.pids.alt.accI,e.throttle=b(e.pids.alt.pContrib+e.pids.alt.dContrib+e.pids.alt.iContrib,0,1)}var m=e.throttle*(.001*a.batteryC*100)/3600,h=e.battery;e.battery=Math.max(0,e.battery-m);var p=(m=h-e.battery)/100*a.j/.001,f=a.motorLiftPerWatt*p,j=new v.btVector3(0,f/1e3,0),g=new v.btVector3(0,0,0);if(i.applyImpulse(j,g),v.destroy(j),v.destroy(g),e.ms%30===0&&(e.batteryChart.push(e.battery),e.yChart.push(s),e.vyChart.push(o)),e.ms+=1,e.stage.includes("training")&&2e4===e.ms){var O=t.sim;if(S(t),t.sim.training=O.training,t.sim.pids=O.pids,console.log(t.sim.training.alt.errs.length+" : "+t.sim.training.alt.currentErrAcc+" / ",t.sim.pids.alt.p+"/"+t.sim.pids.alt.i+"/"+t.sim.pids.alt.d),t.sim.training.alt.errs.length>0&&(t.sim.training.alt[t.sim.training.alt.currentDir],t.sim.training.alt.currentErrAcc<t.sim.training.alt.errs[t.sim.training.alt.errs.length-1]?t.sim.training.alt[t.sim.training.alt.currentDir]*=1.2:t.sim.training.alt[t.sim.training.alt.currentDir]*=-.5),t.sim.training.alt.errs.push(t.sim.training.alt.currentErrAcc),t.sim.training.alt.currentErrAcc=0,t.sim.training.alt.currentDir="p"===t.sim.training.alt.currentDir?"d":"d"===t.sim.training.alt.currentDir?"i":"p",t.sim.pids.alt[t.sim.training.alt.currentDir]+=t.sim.training.alt[t.sim.training.alt.currentDir],t.sim.pids.alt[t.sim.training.alt.currentDir]=Math.max(0,t.sim.pids.alt[t.sim.training.alt.currentDir]),t.sim.training.alt.accI=0,t.sim.training.alt.errs.length>5){var M=t.sim.training.alt.errs,C=M.length;Math.abs(M[C-5]-M[C-4])/M[C-4]<y&&Math.abs(M[C-4]-M[C-3])/M[C-3]<y&&Math.abs(M[C-3]-M[C-2])/M[C-2]<y&&Math.abs(M[C-2]-M[C-1])/M[C-1]<y&&(t.sim.stage="free",t.sim.training.maxspeed=!1)}}};if(t.sim.training.maxspeed)for(var a=0,i=1;performance.now()-r+i<Math.min(e,1e3/60);)n(t),a+=1,i=(performance.now()-r)/a;else for(var s=0;s<e;s++)n(t)}t.sim.simTime=performance.now()-r;for(var o=0;o<t.rigidBodies.length;o++){var c=t.rigidBodies[o],l=c.userData.physicsBody.getMotionState();if(l){l.getWorldTransform(x);var u=x.getOrigin(),d=x.getRotation();c.position.set(u.x(),u.y(),u.z()),c.quaternion.set(d.x(),d.y(),d.z(),d.w())}}}(e.current,t);var c=g(s);R(c),i.render(a,n)}})),Object(f.jsxs)("div",{style:{display:"flex",flexDirection:"row",background:"rgb(62, 62, 62)",overflow:"hidden"},children:[Object(f.jsxs)("div",{style:{position:"relative",overflow:"hidden"},children:[Object(f.jsxs)("div",{style:{position:"absolute",top:"10px",left:"10px",display:"flex",flexDirection:"column"},children:[Object(f.jsxs)("div",{children:[" ",B.ms.toFixed(2)+"ms"]}),Object(f.jsxs)("div",{children:[" ",B.simTime.toFixed(2)+"ms"]}),Object(f.jsxs)("div",{children:[" ",B.deltaToSim.toFixed(2)+"ms"]}),Object(f.jsx)(P,{name:"battery",arrf:function(){var t,r;return null===(t=e.current)||void 0===t||null===(r=t.sim)||void 0===r?void 0:r.batteryChart}}),Object(f.jsx)(P,{name:"y",arrf:function(){var t,r;return null===(t=e.current)||void 0===t||null===(r=t.sim)||void 0===r?void 0:r.yChart}}),Object(f.jsx)(P,{name:"errs",arrf:function(){var t,r;return null===(t=e.current)||void 0===t||null===(r=t.sim)||void 0===r?void 0:r.training.alt.errs}}),Object(f.jsx)("div",{children:function(){var t=B.pids.alt,e=B.training.alt;return Object(f.jsxs)("div",{children:[Object(f.jsxs)("div",{children:["p: ",t.p," + ",e.p]}),Object(f.jsxs)("div",{children:["i: ",t.i," + ",e.i]}),Object(f.jsxs)("div",{children:["d: ",t.d," + ",e.d]})]})}()}),Object(f.jsxs)("div",{children:[Object(f.jsx)("span",{children:"p"}),Object(f.jsx)("input",{type:"range",min:"-1",max:"1",step:"0.01",value:B.pids.alt.pContrib})]}),Object(f.jsxs)("div",{children:[Object(f.jsx)("span",{children:"i"}),Object(f.jsx)("input",{type:"range",min:"-1",max:"1",step:"0.01",value:B.pids.alt.iContrib})]}),Object(f.jsxs)("div",{children:[Object(f.jsx)("span",{children:"d"}),Object(f.jsx)("input",{type:"range",min:"-1",max:"1",step:"0.01",value:B.pids.alt.dContrib})]})]}),Object(f.jsxs)("div",{style:{position:"absolute",bottom:"10px",left:"50%",transform:"translate(-50%,0%)"},children:[Object(f.jsxs)("div",{style:{background:"rgba(0,0,0,0.2)",borderRadius:"5px",padding:"5px",color:"white",cursor:"pointer"},onClick:function(){return e.current.sim.training.maxspeed=!e.current.sim.training.maxspeed},children:["MAX SPEED : ",B.training.maxspeed?"True":"False"]}),Object(f.jsx)("input",(t={type:"range",min:"0",max:"1",value:"0",step:"0.01"},Object(o.a)(t,"value",B.throttle),Object(o.a)(t,"onChange",(function(t){return e.current.sim.throttle=parseFloat(t.target.value)})),t))]}),Object(f.jsx)("canvas",{ref:r,style:{flex:"1 1 auto"}})]}),Object(f.jsxs)("div",{style:{width:"300px",overflowY:"auto",height:"100%"},children:[Object(f.jsx)(V,{name:"motor center distance",unit:"mm",value:s.motorCenterDistance,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{motorCenterDistance:t})}))}}),Object(f.jsx)(V,{name:"motor kv",unit:"RPM/V",value:s.motorKV,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{motorKV:t})}))}}),Object(f.jsx)(V,{name:"single motor mass",unit:"g",value:s.motorMass,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{motorMass:t})}))}}),Object(f.jsx)(V,{name:"motor lift",unit:"N/W",value:s.motorLiftPerWatt,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{motorLiftPerWatt:t})}))}}),Object(f.jsx)(V,{name:"single esc mass",unit:"g",value:s.escMass,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{escMass:t})}))}}),Object(f.jsx)(V,{name:"battery mass",unit:"g",value:s.batteryMass,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{batteryMass:t})}))}}),Object(f.jsx)(V,{name:"battery capacity",unit:"mAh",value:s.batteryCapacity,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{batteryCapacity:t})}))}}),Object(f.jsx)(V,{name:"battery S",unit:"",value:s.batteryS,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{batteryS:t})}))}}),Object(f.jsx)(V,{name:"battery P",unit:"",value:s.batteryP,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{batteryP:t})}))}}),Object(f.jsx)(V,{name:"battery C",unit:"h-1",value:s.batteryC,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{batteryC:t})}))}}),Object(f.jsx)(V,{name:"frame mass",unit:"g",value:s.frameMass,setValue:function(t){return k((function(e){return Object(d.a)(Object(d.a)({},e),{},{frameMass:t})}))}}),Object(f.jsx)(I,{name:"total mass",unit:"g",value:s.totalMass}),Object(f.jsx)(I,{name:"total V",unit:"V",value:s.v}),Object(f.jsx)(I,{name:"max current",unit:"mA",value:s.mA}),Object(f.jsx)(I,{name:"max power",unit:"W",value:s.w})]})]})}function V(t){var e=t.name,r=t.unit,n=t.value,a=t.setValue;return Object(f.jsxs)("div",{style:{color:"white",display:"flex",flexDirection:"row",justifyContent:"space-between",padding:"10px"},children:[Object(f.jsx)("div",{style:{textAlign:"left"},children:e}),Object(f.jsxs)("div",{style:{color:"white",display:"flex",flexDirection:"row",justifyContent:"flex-start",alignItems:"center",width:"120px",flex:"none"},children:[Object(f.jsx)("input",{style:{width:"60px"},value:n,type:"number",onChange:function(t){var e=parseFloat(t.target.value);a(e)}})," ",Object(f.jsx)("span",{style:{marginLeft:"5px"},children:r})]})]})}function I(t){var e=t.name,r=t.unit,n=t.value;return Object(f.jsxs)("div",{style:{color:"white",display:"flex",flexDirection:"row",justifyContent:"space-between",padding:"10px"},children:[Object(f.jsx)("div",{style:{textAlign:"left"},children:e}),Object(f.jsxs)("div",{style:{color:"white",display:"flex",flexDirection:"row",justifyContent:"flex-start",alignItems:"center",width:"120px",flex:"none"},children:[Object(f.jsx)("input",{disabled:!0,style:{width:"60px"},value:n})," ",Object(f.jsx)("span",{style:{marginLeft:"5px"},children:r})]})]})}function P(t){var e=t.arrf,r=t.name,a=Object(n.useRef)(),i=Object(n.useRef)({min:9999,max:-9999,lastComputeIndex:-1}),s=Object(n.useState)(0),o=Object(m.a)(s,2),c=o[0],l=o[1],u=200,d=200;return p((function(t){var r=e();if(a.current&&r&&i.current){i.current.lastComputeIndex>r.length-1&&(i.current={min:9999,max:-9999,lastComputeIndex:-1});var n=i.current;a.current.width=u,a.current.height=d;var s=a.current.getContext("2d");s.width=u,s.height=d,s.fillStyle="rgba(0,0,0,0.2)",s.fillRect(0,0,u,d),r.length>0&&l(r[r.length-1]);for(var o=n.lastComputeIndex+1;o<r.length;o++)n.min=Math.min(n.min,r[o]),n.max=Math.max(n.max,r[o]);n.lastComputeIndex=r.length-1;var c=n.max-n.min,m=n.max+c/10,b=n.min-c/10,h=function(t){return d-d*(t-b)/(m-b)},p=function(t){return t*u/(r.length-1)};s.beginPath(),s.moveTo(p(0),h(r[0]||0)),r.forEach((function(t,e){s.lineTo(p(e),h(t))})),s.strokeStyle="#fff",s.stroke()}})),Object(f.jsxs)("div",{style:{border:"1px solid black",background:"rgba(0,0,0,0.6)",color:"white",width:u+"px"},children:[Object(f.jsxs)("div",{children:[r,": ",c.toFixed(2)]}),Object(f.jsx)("canvas",{ref:a,style:{width:u+"px",height:d+"px"}})]})}var R=function(){return Object(f.jsx)("div",{className:"App",children:Object(f.jsx)(B,{})})},A=function(t){t&&t instanceof Function&&r.e(3).then(r.bind(null,40)).then((function(e){var r=e.getCLS,n=e.getFID,a=e.getFCP,i=e.getLCP,s=e.getTTFB;r(t),n(t),a(t),i(t),s(t)}))};s.a.render(Object(f.jsx)(a.a.StrictMode,{children:Object(f.jsx)(R,{})}),document.getElementById("root")),A()}},[[39,1,2]]]);
//# sourceMappingURL=main.aac83cde.chunk.js.map